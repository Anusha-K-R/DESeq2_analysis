---
title: "RNA seq analysis"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

Install BiocManager as per Bioconductor instructions
```{r}
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.19")
```

Install and load required packages
```{r}
BiocManager::install(c("DESeq2",
                       "affy",
                       "pheatmap",
                       "RColorBrewer",
                       "tidyverse",
                       "apeglm"))
library(DESeq2)
library(affy)
library(pheatmap)
library(RColorBrewer)
library(tidyverse)
library(apeglm)
```

Set working directory and load the rawcount table
```{r}
setwd("C:/workspace/github/differential-expression-analysis/Output/")
list.files()

rawcount <- read.table("C:/workspace/github/differential-expression-analysis/Input/rawcounts.csv",
                       sep = ",",
                       header = TRUE,
                       row.names = 1)

head(rawcount) #Check column names
dim(rawcount) #Check row count
```

Define metadata
```{r}
sample_type <- c("smoc2_oe",
                 "smoc2_oe",
                 "smoc2_oe",
                 "smoc2_oe",
                 "smoc2_oe",
                 "smoc2_oe",
                 "smoc2_oe")
condition <- c("fibrosis",
               "fibrosis",
               "fibrosis",
               "fibrosis",
               "normal",
               "normal",
               "normal")
row_names <- c("smoc2_fibrosis1",
               "smoc2_fibrosis2",
               "smoc2_fibrosis3",
               "smoc2_fibrosis4",
               "smoc2_normal1",
               "smoc2_normal3",
               "smoc2_normal4")
defcolor <- c("fibrosis" <- "salmon1",
              "normal" <- "cadetblue1")

#Create metadata datadrame
metadata <- data.frame(row.names = TRUE,
                       row_names,
                       sample_type,
                       condition)

#Asign colors to conditions
metadata$color <- defcolor[as.vector(metadata$condition)]

head(metadata) #Check table structure
table(metadata$condition) #Count number of samples per condition
```

Reorder the columns of rawcount table to match the row order of metadata
```{r}
# Define reorder parameters
fn <- match(rownames(metadata),
            colnames(rawcount))

#Reorder the colums
reordered_rawcounts <- rawcount[, fn]
if (identical(colnames(reordered_rawcounts),
              rownames(metadata)) == FALSE)
  print("sample order of the dataset do not match with rows of metadata")
```

Visualize rawcount data
```{r}
barplot(colSums(reordered_rawcounts) / 1000000,
        col = metadata$color,
        ylab = "Million counts",
        cex.names = 1,
        las = 2,
        ylim = c(0, 30))
```

Normalize gene counts
```{r}
# Create a DESeq2 object
dds <- DESeqDataSetFromMatrix(countData = reordered_rawcounts,
                              colData =  metadata,
                              design = ~ condition)

#Determine the size factors
dds <- estimateSizeFactors(dds)

# Extract the normalized counts
normalized_count <- counts(dds,
                           normalized = TRUE)
```


PCA plot of transformed normalized gene counts
```{r}
vsd <- vst(dds, blind = TRUE) # Transform the normalized counts
# Plot the PCA of PC1 and PC2
plotPCA(vsd,
        intgroup = "condition")
```

Plot heatmap of corelation values
```{r}
vsd_mat <- assay(vsd) # Extract the transformed counts matrix
vsd_cor <- cor(vsd_mat) # Compute the correlation between samples
pheatmap(vsd_cor) # Plot heatmap of correlation values
```

Plot dispersions
```{r}
dds_dis <- DESeq(dds)
plotDispEsts(dds_dis)
```

Extract and shrink results
```{r}
# Extract results
# Extract results
res <- results(dds_dis,
               alpha = 0.05,
               lfcThreshold = 0.32) #0.32 lfcThreshold for 1.25 fold change

# Shrink the log2 fold changes
res <- lfcShrink(dds_dis,
                 type = "apeglm",
                 coef = 2,
                 res = res)

summary(res) #Overview of the results
```

MA plot of log2FC
```{r}
plotMA(res,
       alpha = 0.1)
abline(h = c(-1:1),
       col = "red")
```

Subset the significant DEGs
```{r}
#Generate result table
deg <- data.frame(res)
# Create subset of results having only the significant DEGs
deg_sig <- subset(deg,
                  padj < 0.05)
```

Volcano plot of significant DEGs, where red and green dots represent down-regulated and up-regulated genes, respectively, with the fold change of greater than 1.
```{r}
de <- deg[complete.cases(deg), ] #Filter out NA
#Add new column to define differential expression
de$diffexpressed <- "NO"
#Define up-regulated and down-regulated genes
de$diffexpressed[de$log2FoldChange > 1 & de$padj < 0.05] <- "UP"
de$diffexpressed[de$log2FoldChange < -1 & de$padj < 0.05] <- "DOWN"
#Asign colors
mycolors <- c("red", "green", "grey")
names(mycolors) <- c("DOWN", "UP", "NO")

ggplot(data = de,
       aes(x = log2FoldChange,
           y = -log10(pvalue),
           col = diffexpressed)) +
  geom_point() +
  theme_minimal() +
  scale_colour_manual(values = mycolors) +
  geom_vline(xintercept = c(-1, 1),
             col = "black") +
  geom_hline(yintercept = -log10(0.05),
             col = "black")
```

Heatmap of normalized counts of significant DEGs
```{r}
#Generate a table with normalized counts
normalized_count_table <- data.frame(normalized_count)

# Subset the table having only significant DEGs
sig_norm_counts <- normalized_count_table[rownames(deg_sig), ]

# Plot heatmap
pheatmap(sig_norm_counts,
         cluster_rows = TRUE,
         show_rownames = FALSE,
         scale = "row")
```
Export DEG data
```{r}
write.table(deg_sig,
            "DESeq2_DEG_sig.txt",
            sep = "\t",
            row.names = TRUE)
```
